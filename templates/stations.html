{% extends "base.html" %}

{% block title %}Estaciones de Carga - Electric Cars Database{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="section-title">Gestión de Estaciones de Carga</h1>

    <div class="info-block mb-5">
        <h2 class="h4 text-primary mb-3"><i class="fas fa-plus-circle me-2"></i>Registrar Nueva Estación / Actualizar Existente</h2>
        <form id="estacionForm" onsubmit="submitEstacionForm(event)">
            <div class="mb-3">
                <label for="estacionId" class="form-label">ID de la Estación (se autogenera al crear, para actualizar se carga automáticamente)</label>
                <input type="text" class="form-control" id="estacionId" name="id" placeholder="Automático para nuevo, cargado para actualizar" readonly>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre" class="form-label">Nombre de la Estación</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" required minlength="2" maxlength="50" pattern="[A-Za-z0-9\s-]+" title="Solo letras, números, espacios y guiones." oninput="validateInput(this)">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="ubicacion" class="form-label">Ubicación</label>
                    <input type="text" class="form-control" id="ubicacion" name="ubicacion" value="Bogotá" readonly required>
                    <small class="form-text text-muted">Actualmente solo se permite la ciudad de Bogotá.</small>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="tipoConector" class="form-label">Tipo de Conector</label>
                    <select class="form-select" id="tipoConector" name="tipo_conector" required>
                        <option value="">Seleccione un tipo</option>
                        <option value="CCS">CCS (Combined Charging System)</option>
                        <option value="CHAdeMO">CHAdeMO</option>
                        <option value="Tipo 2">Tipo 2 (Mennekes)</option>
                        <option value="Schuko">Schuko (Enchufe doméstico)</option>
                        <option value="Tesla">Tesla (Supercharger/Destination Charger)</option>
                    </select>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="potenciaKw" class="form-label">Potencia (kW)</label>
                    <input type="number" step="0.1" class="form-control" id="potenciaKw" name="potencia_kw" required min="3.7" max="350" title="Potencia de carga en kW (ej. 7.4, 50, 150)." oninput="validateInput(this)">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="numConectores" class="form-label">Número de Conectores</label>
                    <input type="number" class="form-control" id="numConectores" name="num_conectores" required min="1" max="20" title="Número de conectores disponibles en la estación." oninput="validateInput(this)">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3 form-check form-switch d-flex align-items-center mt-4">
                    <input class="form-check-input" type="checkbox" id="accesoPublico" name="acceso_publico" checked>
                    <label class="form-check-label ms-2" for="accesoPublico">Acceso Público</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="horarioApertura" class="form-label">Horario de Apertura</label>
                    <input type="text" class="form-control" id="horarioApertura" name="horario_apertura" required minlength="3" maxlength="50" title="Horario de operación de la estación (ej. 24/7, 9 AM - 6 PM)." oninput="validateInput(this)">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="costePorKwh" class="form-label">Coste por kWh</label>
                    <input type="number" step="0.01" class="form-control" id="costePorKwh" name="coste_por_kwh" required min="0" max="10" title="Costo de la electricidad por kWh (ej. 0.25, 0.50)." oninput="validateInput(this)">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="mb-3">
                <label for="operador" class="form-label">Operador</label>
                <input type="text" class="form-control" id="operador" name="operador" required minlength="2" maxlength="50" pattern="[A-Za-z0-9\s-]+" title="Nombre del operador de la estación (ej. Enel X, Celsia)." oninput="validateInput(this)">
                <div class="invalid-feedback"></div>
            </div>

            <div class="mb-3">
                <label for="url_imagen_file_estacion" class="form-label">Imagen (opcional)</label>
                <input type="file" class="form-control" id="url_imagen_file_estacion" name="url_imagen_file" accept="image/*" onchange="previewImage(event, 'imagePreviewEstacion')">
                <input type="hidden" id="url_imagen_estacion" name="url_imagen">
                <small class="form-text text-muted">Sube una imagen de la estación de carga.</small>
                <img id="imagePreviewEstacion" src="" alt="Vista previa de imagen" class="img-thumbnail mt-2" style="max-width: 150px; display: none;">
            </div>

            <button type="submit" class="btn btn-primary me-2"><i class="fas fa-save me-2"></i>Guardar Estación</button>
            <button type="button" class="btn btn-secondary" onclick="clearEstacionForm()"><i class="fas fa-redo me-2"></i>Limpiar Formulario</button>
        </form>
    </div>

    <div class="info-block">
        <h2 class="h4 text-success mb-3"><i class="fas fa-list me-2"></i>Listado de Estaciones de Carga</h2>
        <div class="mb-3">
            <input type="text" id="searchEstacion" class="form-control" onkeyup="filterEstaciones()" placeholder="Buscar por nombre o tipo de conector...">
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Ubicación</th>
                        <th>Tipo Conector</th>
                        <th>Potencia (kW)</th>
                        <th>Num. Conectores</th>
                        <th>Acceso Público</th>
                        <th>Horario</th>
                        <th>Coste/kWh</th>
                        <th>Operador</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="estacionesTableBody">
                    </tbody>
            </table>
        </div>
        <div id="noEstacionesMessage" class="text-center text-muted py-4" style="display: none;">
            No hay estaciones de carga disponibles.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Funciones de validación para inputs
    function validateInput(input) {
        if (input.checkValidity()) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            input.nextElementSibling.innerText = ''; // Clear custom error message
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            input.nextElementSibling.innerText = input.validationMessage; // Show browser default error
        }
    }

    async function submitEstacionForm(event) {
        event.preventDefault(); // Evitar el envío de formulario por defecto

        const form = document.getElementById('estacionForm');
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        form.classList.remove('was-validated');

        const estacionId = document.getElementById('estacionId').value;
        const nombre = document.getElementById('nombre').value;
        const ubicacion = document.getElementById('ubicacion').value; // Siempre será Bogotá
        const tipoConector = document.getElementById('tipoConector').value;
        const potenciaKw = parseFloat(document.getElementById('potenciaKw').value);
        const numConectores = parseInt(document.getElementById('numConectores').value);
        const accesoPublico = document.getElementById('accesoPublico').checked;
        const horarioApertura = document.getElementById('horarioApertura').value;
        const costePorKwh = parseFloat(document.getElementById('costePorKwh').value);
        const operador = document.getElementById('operador').value;

        const urlImagenInput = document.getElementById('url_imagen_estacion'); // Hidden input
        const fileInput = document.getElementById('url_imagen_file_estacion');
        let urlImagen = urlImagenInput.value;

        // Si hay un nuevo archivo seleccionado, subirlo primero
        if (fileInput.files.length > 0) {
            const uploadedUrl = await uploadImage(fileInput.files[0], 'estacion');
            if (uploadedUrl) {
                urlImagen = uploadedUrl;
            } else {
                alert('Error al subir la imagen. Por favor, inténtelo de nuevo.');
                return;
            }
        }

        const estacionData = {
            nombre: nombre,
            ubicacion: ubicacion,
            tipo_conector: tipoConector,
            potencia_kw: potenciaKw,
            num_conectores: numConectores,
            acceso_publico: accesoPublico,
            horario_apertura: horarioApertura,
            coste_por_kwh: costePorKwh,
            operador: operador,
            url_imagen: urlImagen || null
        };

        try {
            let response;
            if (estacionId) {
                // Actualizar estación existente
                response = await fetch(`/estaciones/${estacionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(estacionData),
                });
            } else {
                // Crear nueva estación
                response = await fetch('/estaciones/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(estacionData),
                });
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al guardar la estación.');
            }

            alert('Estación de carga guardada exitosamente!');
            clearEstacionForm();
            loadEstaciones();
        } catch (error) {
            console.error('Error al guardar estación:', error);
            alert('Error al guardar estación de carga: ' + error.message);
        }
    }

    async function uploadImage(file, type) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/upload_image/', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al subir la imagen.');
            }
            const data = await response.json();
            return data.url;
        } catch (error) {
            console.error('Error uploading image:', error);
            return null;
        }
    }

    async function loadEstaciones() {
        try {
            const response = await fetch('/estaciones/');
            if (!response.ok) {
                throw new Error('Error al cargar las estaciones de carga.');
            }
            const estaciones = await response.json();
            const tableBody = document.getElementById('estacionesTableBody');
            tableBody.innerHTML = ''; // Limpiar tabla

            const noEstacionesMessage = document.getElementById('noEstacionesMessage');

            if (estaciones.length === 0) {
                noEstacionesMessage.style.display = 'block';
            } else {
                noEstacionesMessage.style.display = 'none';
                estaciones.forEach(estacion => {
                    const row = tableBody.insertRow();
                    row.insertCell().innerText = estacion.id;
                    const imgCell = row.insertCell();
                    if (estacion.url_imagen) {
                        imgCell.innerHTML = `<img src="${estacion.url_imagen}" alt="Imagen de ${estacion.nombre}" class="img-thumbnail img-thumbnail-square">`;
                    } else {
                        imgCell.innerText = 'No image';
                    }
                    row.insertCell().innerText = estacion.nombre;
                    row.insertCell().innerText = estacion.ubicacion;
                    row.insertCell().innerText = estacion.tipo_conector;
                    row.insertCell().innerText = estacion.potencia_kw;
                    row.insertCell().innerText = estacion.num_conectores;

                    const accesoCell = row.insertCell();
                    if (estacion.acceso_publico) {
                        accesoCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Sí</span>';
                    } else {
                        accesoCell.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times-circle"></i> No</span>';
                    }

                    row.insertCell().innerText = estacion.horario_apertura;
                    row.insertCell().innerText = estacion.coste_por_kwh;
                    row.insertCell().innerText = estacion.operador;

                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-info me-2" onclick="editEstacion(${estacion.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEstacion(${estacion.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                });
            }
        } catch (error) {
            console.error('Error al cargar estaciones:', error);
            alert('Error al cargar estaciones de carga: ' + error.message);
        }
    }

    async function editEstacion(estacionId) {
        try {
            const response = await fetch(`/estaciones/${estacionId}`);
            if (!response.ok) {
                throw new Error('Error al cargar la estación para edición.');
            }
            const estacion = await response.json();
            document.getElementById('estacionId').value = estacion.id;
            document.getElementById('nombre').value = estacion.nombre;
            // La ubicación siempre será 'Bogotá' y readonly
            document.getElementById('ubicacion').value = 'Bogotá';
            document.getElementById('tipoConector').value = estacion.tipo_conector;
            document.getElementById('potenciaKw').value = estacion.potencia_kw;
            document.getElementById('numConectores').value = estacion.num_conectores;
            document.getElementById('accesoPublico').checked = estacion.acceso_publico;
            document.getElementById('horarioApertura').value = estacion.horario_apertura;
            document.getElementById('costePorKwh').value = estacion.coste_por_kwh;
            document.getElementById('operador').value = estacion.operador;
            document.getElementById('url_imagen_estacion').value = estacion.url_imagen || '';

            // Mostrar vista previa de la imagen si existe
            const imagePreview = document.getElementById('imagePreviewEstacion');
            if (estacion.url_imagen) {
                imagePreview.src = estacion.url_imagen;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }

        } catch (error) {
            console.error('Error al editar estación:', error);
            alert('Error al cargar datos de la estación para edición: ' + error.message);
        }
    }

    async function deleteEstacion(estacionId) {
        if (!confirm('¿Está seguro de que desea eliminar esta estación? Esta acción lo moverá al historial de eliminados.')) {
            return;
        }

        try {
            const response = await fetch(`/estaciones/${estacionId}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al eliminar la estación.');
            }

            alert('Estación eliminada exitosamente y movida al historial!');
            loadEstaciones();
        } catch (error) {
            console.error('Error al eliminar estación:', error);
            alert('Error al eliminar estación: ' + error.message);
        }
    }

    function clearEstacionForm() {
        document.getElementById('estacionForm').reset();
        document.getElementById('estacionId').value = '';
        document.getElementById('url_imagen_estacion').value = '';
        document.getElementById('url_imagen_file_estacion').value = ''; // Limpiar el input de file
        // Asegurar que la ubicación siempre sea 'Bogotá' al limpiar
        document.getElementById('ubicacion').value = 'Bogotá';
        // Ocultar la vista previa de la imagen
        document.getElementById('imagePreviewEstacion').src = '';
        document.getElementById('imagePreviewEstacion').style.display = 'none';

        document.getElementById('estacionForm').classList.remove('was-validated');
        document.querySelectorAll('#estacionForm .form-control').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
            if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                input.nextElementSibling.innerText = '';
            }
        });
    }

    function filterEstaciones() {
        const input = document.getElementById('searchEstacion');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('estacionesTableBody');
        const tr = table.getElementsByTagName('tr');
        let anyVisible = false;

        for (let i = 0; i < tr.length; i++) {
            const tdNombre = tr[i].getElementsByTagName('td')[2]; // Columna de Nombre
            const tdConector = tr[i].getElementsByTagName('td')[4]; // Columna de Tipo Conector
            if (tdNombre && tdConector) {
                const textValueNombre = tdNombre.textContent || tdNombre.innerText;
                const textValueConector = tdConector.textContent || tdConector.innerText;
                if (textValueNombre.toLowerCase().indexOf(filter) > -1 || textValueConector.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                    anyVisible = true;
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
        document.getElementById('noEstacionesMessage').style.display = anyVisible ? 'none' : 'block';
    }

    // Cargar estaciones al cargar la página inicialmente
    document.addEventListener('DOMContentLoaded', loadEstaciones);
</script>
{% endblock %}