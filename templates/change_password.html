{% extends "base.html" %}

{% block title %}Cambiar Contraseña{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="section-title text-center mb-4">Cambio de Contraseña</h1>

    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="info-block p-4 shadow-lg">

                {% if error_message %}
                <div class="alert alert-danger fade-in" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}
                </div>
                {% endif %}

                <form action="{{ url_for('handle_change_password') }}" method="post" id="changePasswordForm" novalidate>

                    <div class="mb-3">
                        <label for="identificador" class="form-label"><i class="fas fa-id-badge me-2"></i>Cédula o Correo (Identificador)</label>
                        <input type="text" class="form-control" id="identificador" name="identificador" required value="{{ form_data.get('identificador', '') if form_data else '' }}">
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                        <small class="form-text text-muted">Ingresa tu cédula o el correo electrónico de tu cuenta.</small>
                    </div>

                    <div class="mb-4">
                        <label for="password_anterior" class="form-label"><i class="fas fa-unlock me-2"></i>Contraseña Anterior (Opcional si usa Cédula)</label>
                        <div class="input-group">
                            <input type="password" class="form-control password-input" id="password_anterior" name="password_anterior" placeholder="Solo si identificador es el correo">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Solo necesaria si usas tu correo como identificador.</small>
                    </div>

                    <div class="mb-3">
                        <label for="password_nueva" class="form-label"><i class="fas fa-lock me-2"></i>Nueva Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control password-input" id="password_nueva" name="password_nueva" required minlength="8" oninput="validateNewPassword()">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <div class="invalid-feedback" id="feedback_nueva">Debe tener **mínimo 8 caracteres** y **al menos un número**.</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="password_nueva_confirmacion" class="form-label"><i class="fas fa-redo-alt me-2"></i>Confirmar Nueva Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control password-input" id="password_nueva_confirmacion" name="password_nueva_confirmacion" required minlength="8" oninput="validateNewPassword()">
                            <button class="btn btn-outline-secondary toggle-password" type="button">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <div class="invalid-feedback" id="feedback_confirmacion">Las contraseñas no coinciden.</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-warning w-100 btn-lg"><i class="fas fa-sync-alt me-2"></i>Cambiar Contraseña</button>
                </form>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Script de Toggle para todas las Contraseñas
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.closest('.input-group').querySelector('.password-input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);

            // Cambiar el icono
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });
    });

    // Script de Validación de Nueva Contraseña
    const nuevaPassword = document.getElementById('password_nueva');
    const confirmacionPassword = document.getElementById('password_nueva_confirmacion');
    const form = document.getElementById('changePasswordForm');

    function validateNewPassword() {
        const passNueva = nuevaPassword.value;
        const passConfirmacion = confirmacionPassword.value;
        const feedbackNueva = document.getElementById('feedback_nueva');
        const feedbackConfirmacion = document.getElementById('feedback_confirmacion');

        const isValidLength = passNueva.length >= 8;
        const hasNumber = /\d/.test(passNueva);

        // 1. Validación de la nueva contraseña (longitud y número)
        if (isValidLength && hasNumber) {
            nuevaPassword.classList.remove('is-invalid');
            nuevaPassword.classList.add('is-valid');
        } else {
            nuevaPassword.classList.remove('is-valid');
            nuevaPassword.classList.add('is-invalid');
            if (!isValidLength) {
                feedbackNueva.innerText = "La nueva contraseña debe tener al menos 8 caracteres.";
            } else if (!hasNumber) {
                feedbackNueva.innerText = "La nueva contraseña debe contener al menos un número.";
            }
        }

        // 2. Validación de coincidencia
        if (passConfirmacion.length > 0) {
            if (passNueva === passConfirmacion) {
                confirmacionPassword.classList.remove('is-invalid');
                confirmacionPassword.classList.add('is-valid');
            } else {
                confirmacionPassword.classList.remove('is-valid');
                confirmacionPassword.classList.add('is-invalid');
                feedbackConfirmacion.innerText = "Las contraseñas no coinciden.";
            }
        }
    }

    // Validación de Bootstrap 5 al enviar
    form.addEventListener('submit', function (event) {
        validateNewPassword(); // Re-validar antes de enviar

        if (!this.checkValidity() || nuevaPassword.classList.contains('is-invalid') || confirmacionPassword.classList.contains('is-invalid')) {
            event.preventDefault();
            event.stopPropagation();
        }
        this.classList.add('was-validated');
    }, false);
</script>
{% endblock %}